<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validaci√≥n Facial</title>
    <!-- Incluir Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos base para Inter font */
        body { font-family: 'Inter', sans-serif; }
        /* Estilo para el contenedor del video */
        #video-container {
            position: relative;
            width: 100%;
            height: 256px; /* 64 * 4 = 256px, coincidiendo con h-64 de Tailwind */
            overflow: hidden;
            border-radius: 0.5rem; /* rounded-lg */
        }
        #video-stream {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Asegura que el video cubra el contenedor sin distorsionarse */
            transform: scaleX(-1); /* Espejo horizontal para simular un selfie */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Se debe incluir el token CSRF para que el JavaScript lo lea y lo env√≠e en el POST -->
    {% csrf_token %}

    <!-- Tarjeta Principal de Validaci√≥n -->
    <div id="validation-card" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transition-all duration-300 transform scale-100">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 text-center">
            Validaci√≥n de Asistencia
        </h1>
        
        <p class="text-lg text-gray-600 mb-6 text-center">
            Bienvenido, <span id="empleado-nombre" class="font-extrabold text-blue-600">{{ empleado.nombre }}</span>.
        </p>

        <!-- Contenedor de la C√°mara/Validaci√≥n -->
        <div id="video-container" class="bg-gray-800 flex items-center justify-center mb-6 shadow-inner border-2 border-gray-300">
            <!-- Elemento de video real -->
            <video id="video-stream" autoplay playsinline class="hidden"></video>
            <!-- Mensaje de carga inicial -->
            <p id="camera-loading-message" class="text-white font-medium p-4 text-center">
                Cargando c√°mara... (Aseg√∫rese de aceptar el permiso)
            </p>
        </div>

        <!-- Mensaje de Estado (Display Din√°mico) -->
        <div id="status-message" class="p-3 mb-6 rounded-lg font-medium text-center bg-blue-100 text-blue-700 border border-blue-300">
            Esperando validaci√≥n facial...
        </div>

        <!-- Bot√≥n de Registro (Activado despu√©s de la validaci√≥n exitosa o de forma manual) -->
        <button id="register-button" 
                disabled
                class="w-full py-3 bg-gray-400 text-white font-bold rounded-lg shadow-lg transition duration-150 transform focus:outline-none focus:ring-4 focus:ring-green-300">
            Registrar Asistencia
        </button>
        
        <div id="loading-indicator" class="hidden text-center mt-4 text-green-600 font-medium">
            Procesando...
        </div>

    </div>

    <script>
        // La URL de registro es inyectada por Django desde la vista
        const FINAL_REGISTER_URL = '{{ registro_url | safe }}';
        
        // Obtenemos el token CSRF (debe existir en la plantilla que llam√≥ a esta vista)
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        // Usamos un operador ternario para una lectura segura, evitando el TypeError
        const csrfToken = csrfTokenElement ? csrfTokenElement.value : '';

        const registerButton = document.getElementById('register-button');
        const statusMsg = document.getElementById('status-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const videoElement = document.getElementById('video-stream');
        const cameraMessage = document.getElementById('camera-loading-message');

        let cameraActive = false;
        
        // --- UTILIDAD: Actualiza el estado en la interfaz ---
        function updateStatus(message, type = 'info') {
            statusMsg.textContent = message;
            statusMsg.className = 'p-3 mb-6 rounded-lg font-medium text-center border transition-colors duration-200';
            
            if (type === 'success') {
                statusMsg.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
            } else if (type === 'error') {
                statusMsg.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
            } else { // info / default
                statusMsg.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-300');
            }
        }

        // --- FUNCI√ìN DE INICIALIZACI√ìN DE C√ÅMARA ---
        async function startCamera() {
            if (cameraActive) return;

            try {
                updateStatus('Cargando c√°mara...', 'info');
                cameraMessage.textContent = 'Solicitando permiso de c√°mara...';
                
                // Pedir acceso a la c√°mara de video
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                
                // Asignar el stream al elemento de video
                videoElement.srcObject = stream;
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    // Mostrar video y ocultar mensaje
                    videoElement.classList.remove('hidden');
                    cameraMessage.classList.add('hidden');
                    cameraActive = true;
                    
                    updateStatus('C√°mara activa. Presione "Registrar Asistencia" para continuar.', 'info');
                    // Simular que la validaci√≥n facial fue exitosa (Activamos el bot√≥n)
                    registerButton.disabled = false;
                    registerButton.classList.remove('bg-gray-400');
                    registerButton.classList.add('bg-green-600', 'hover:bg-green-700');
                };
            } catch (error) {
                console.error('[ERROR C√ÅMARA]: Error al acceder a la c√°mara:', error);
                let errorMessage = 'Error al acceder a la c√°mara. Aseg√∫rese de que no est√© en uso.';

                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Permiso denegado: Debe permitir el acceso a la c√°mara para continuar.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No se encontr√≥ ninguna c√°mara disponible.';
                }
                
                cameraMessage.textContent = errorMessage;
                updateStatus(`‚ùå ${errorMessage}`, 'error');
                
                // Dejamos el bot√≥n deshabilitado si la c√°mara no funciona
                registerButton.disabled = true;
                registerButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                registerButton.classList.add('bg-gray-400');
            }
        }

        // --- FUNCI√ìN DE REGISTRO DE ASISTENCIA ---
        async function registerAttendance() {
            if (!csrfToken) {
                updateStatus('Error de seguridad: Token CSRF no disponible.', 'error');
                return;
            }

            registerButton.disabled = true;
            registerButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            registerButton.classList.add('bg-gray-400');
            loadingIndicator.classList.remove('hidden');
            updateStatus('Enviando registro al servidor...', 'info');

            try {
                const response = await fetch(FINAL_REGISTER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    // No necesitamos enviar body, ya que el ID del empleado est√° en la URL
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Error del servidor: ${response.status}`);
                }

                const data = await response.json();
                
                // --- MANEJO DEL √âXITO ---
                const nombre = data.nombre || 'Empleado';
                const tipo = data.tipo || 'registro';

                updateStatus(`üéâ √âxito: ${data.message || `Asistencia registrada para ${nombre} (${tipo.toUpperCase()}).`}`, 'success');
                
                registerButton.textContent = `‚úÖ REGISTRO DE ${tipo.toUpperCase()} COMPLETADO`;
                registerButton.disabled = true;

            } catch (error) {
                console.error('Error durante el registro:', error);
                const errorMessage = error.message || "Error de red o formato de datos.";
                
                updateStatus(`‚ùå Error de comunicaci√≥n: ${errorMessage}`, 'error');
                
                // Restaurar el bot√≥n para que el usuario pueda reintentar
                registerButton.disabled = false;
                registerButton.classList.remove('bg-gray-400');
                registerButton.classList.add('bg-green-600', 'hover:bg-green-700');

            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Verificar el token CSRF al cargar
            if (!csrfToken) {
                updateStatus('ERROR GRAVE: El token CSRF no se pudo leer. No se puede registrar la asistencia.', 'error');
            } else {
                console.log('[√âXITO CSRF] Token encontrado.');
            }
            
            // 2. Iniciar la c√°mara
            startCamera();

            // 3. A√±adir listener al bot√≥n de registro
            registerButton.addEventListener('click', registerAttendance);
        });
        
    </script>
</body>
</html>
