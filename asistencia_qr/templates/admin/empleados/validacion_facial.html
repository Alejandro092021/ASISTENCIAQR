{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validaci√≥n Facial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos base para Inter font */
        body { font-family: 'Inter', sans-serif; }
        /* Estilo para el contenedor del video */
        #video-container {
            position: relative;
            width: 100%;
            height: 256px; /* 64 * 4 = 256px, coincidiendo con h-64 de Tailwind */
            overflow: hidden;
            border-radius: 0.5rem; /* rounded-lg */
        }
        #video-stream {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Asegura que el video cubra el contenedor sin distorsionarse */
            transform: scaleX(-1); /* Espejo horizontal para simular un selfie */
        }
        /* Estilo para simular el indicador de rostro (opcional, para visualizaci√≥n) */
        .face-indicator::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 80%;
            border: 4px dashed #38bdf8; /* cian-400 */
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-sizing: border-box;
            pointer-events: none;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    {% csrf_token %}

    <div id="validation-card" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transition-all duration-300 transform scale-100">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 text-center">
            Validaci√≥n de Asistencia
        </h1>
        
        <p class="text-lg text-gray-600 mb-6 text-center">
            Bienvenido, <span id="empleado-nombre" class="font-extrabold text-blue-600">{{ empleado.nombre }}</span>.
        </p>
        
        <input type="hidden" id="empleado_id" value="{{ empleado.id }}">

        <div id="video-container" class="bg-gray-800 flex items-center justify-center mb-6 shadow-inner border-2 border-gray-300 face-indicator">
            <video id="video-stream" autoplay playsinline class="hidden"></video>
            <p id="camera-loading-message" class="text-white font-medium p-4 text-center">
                Cargando c√°mara... (Aseg√∫rese de aceptar el permiso)
            </p>
        </div>
        
        <canvas id="photo-canvas" class="hidden"></canvas> 

        <div id="status-message" class="p-3 mb-6 rounded-lg font-medium text-center bg-blue-100 text-blue-700 border border-blue-300">
            Esperando validaci√≥n facial...
        </div>

        <button id="register-button" 
                disabled
                class="w-full py-3 bg-gray-400 text-white font-bold rounded-lg shadow-lg transition duration-150 transform focus:outline-none focus:ring-4 focus:ring-green-300 cursor-not-allowed">
            Registrar Asistencia
        </button>
        
        <div id="loading-indicator" class="hidden text-center mt-4 text-green-600 font-medium">
            Procesando...
        </div>

    </div>

    <script>
        // üö® CR√çTICO: Asumiendo que la vista (views.py) env√≠a 'registro_url' en el contexto.
        // Si no es as√≠, reemplace con: const FINAL_REGISTER_URL = "{% url 'registrar_asistencia_final' empleado_id=empleado.id %}";
        const FINAL_REGISTER_URL = '{{ registro_url | safe }}';
        
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        const csrfToken = csrfTokenElement ? csrfTokenElement.value : '';

        const registerButton = document.getElementById('register-button');
        const statusMsg = document.getElementById('status-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const videoElement = document.getElementById('video-stream');
        const cameraMessage = document.getElementById('camera-loading-message');
        
        // üö® NUEVOS ELEMENTOS DE CAPTURA
        const canvasElement = document.getElementById('photo-canvas');
        const empleadoId = document.getElementById('empleado_id').value;

        let cameraActive = false;
        let streamGlobal = null; // Guardar el stream para poder detenerlo

        // --- UTILIDAD: Actualiza el estado en la interfaz ---
        function updateStatus(message, type = 'info') {
            statusMsg.textContent = message;
            // ... (L√≥gica de clases de Tailwind existente) ...
            statusMsg.className = 'p-3 mb-6 rounded-lg font-medium text-center border transition-colors duration-200';
            
            if (type === 'success') {
                statusMsg.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
            } else if (type === 'error') {
                statusMsg.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
            } else { // info / default
                statusMsg.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-300');
            }
        }

        // --- FUNCI√ìN DE CAPTURA: Toma una foto del video y devuelve Base64 ---
        function captureImage() {
            if (!videoElement.srcObject) {
                updateStatus('Error: La c√°mara no est√° activa para capturar.', 'error');
                return null;
            }
            
            // Ajustar canvas al tama√±o del video (importante para evitar distorsi√≥n)
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            
            const context = canvasElement.getContext('2d');
            
            // üö® CR√çTICO: Dibujar el video con el efecto espejo (si lo est√° usando)
            // 1. Mover el punto de inicio a la derecha
            context.translate(canvasElement.width, 0);
            // 2. Escalar horizontalmente por -1
            context.scale(-1, 1);
            // 3. Dibujar la imagen
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            
            // Devolver la imagen en formato Base64 (JPEG)
            return canvasElement.toDataURL('image/jpeg', 0.9); // Calidad 0.9
        }

        // --- FUNCI√ìN DE DETENER C√ÅMARA ---
        function stopCamera() {
            if (streamGlobal) {
                streamGlobal.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
                cameraActive = false;
            }
        }

        // --- FUNCI√ìN DE INICIALIZACI√ìN DE C√ÅMARA ---
        async function startCamera() {
            if (cameraActive) return;

            try {
                updateStatus('Cargando c√°mara...', 'info');
                cameraMessage.textContent = 'Solicitando permiso de c√°mara...';
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                
                streamGlobal = stream; // Guardar el stream
                videoElement.srcObject = stream;
                
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    videoElement.classList.remove('hidden');
                    cameraMessage.classList.add('hidden');
                    cameraActive = true;
                    
                    updateStatus('C√°mara activa. Presione "Registrar Asistencia" para capturar y continuar.', 'info');
                    
                    // Activamos el bot√≥n ya que la c√°mara est√° lista
                    registerButton.disabled = false;
                    registerButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    registerButton.classList.add('bg-green-600', 'hover:bg-green-700');
                };
            } catch (error) {
                // ... (L√≥gica de manejo de errores existente) ...
                console.error('[ERROR C√ÅMARA]: Error al acceder a la c√°mara:', error);
                let errorMessage = 'Error al acceder a la c√°mara. Aseg√∫rese de que no est√© en uso.';

                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Permiso denegado: Debe permitir el acceso a la c√°mara para continuar.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No se encontr√≥ ninguna c√°mara disponible.';
                }
                
                cameraMessage.textContent = errorMessage;
                updateStatus(`‚ùå ${errorMessage}`, 'error');
                
                // Dejamos el bot√≥n deshabilitado si la c√°mara no funciona
                registerButton.disabled = true;
                registerButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                registerButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        // --- FUNCI√ìN DE REGISTRO DE ASISTENCIA (MODIFICADA) ---
        async function registerAttendance() {
            if (!csrfToken || registerButton.disabled) return;

            // 1. CAPTURAR LA IMAGEN
            const imageData = captureImage();
            if (!imageData) {
                updateStatus('‚ùå Fallo en la captura de la imagen. Intente de nuevo.', 'error');
                return;
            }

            // 2. INICIAR PROCESO DE POST
            registerButton.disabled = true;
            registerButton.textContent = 'Procesando Validaci√≥n Facial y Registro...';
            registerButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            registerButton.classList.add('bg-gray-400');
            loadingIndicator.classList.remove('hidden');
            updateStatus('Enviando imagen y registrando al servidor...', 'info');

            try {
                // 3. ENVIAR DATOS (incluyendo la imagen Base64)
                const response = await fetch(FINAL_REGISTER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        empleado_id: empleadoId,
                        // üö® CR√çTICO: La imagen Base64 va aqu√≠
                        foto_capturada: imageData, 
                        // Puedes a√±adir el tipo de asistencia si es relevante, ej: 'tipo': 'entrada'
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Error del servidor: ${response.status}`);
                }

                const data = await response.json();
                
                // --- MANEJO DEL √âXITO ---
                stopCamera(); // Detenemos la c√°mara tras el √©xito
                
                const nombre = data.nombre || 'Empleado';
                const tipo = data.tipo || 'registro';

                updateStatus(`üéâ √âxito: ${data.message || `Asistencia registrada para ${nombre} (${tipo.toUpperCase()}).`}`, 'success');
                
                registerButton.textContent = `‚úÖ REGISTRO DE ${tipo.toUpperCase()} COMPLETADO`;
                registerButton.disabled = true;
                
                // Opcional: Cerrar ventana
                setTimeout(() => { window.close(); }, 4000);

            } catch (error) {
                // ... (Manejo de errores) ...
                console.error('Error durante el registro:', error);
                const errorMessage = error.message || "Error de red o formato de datos.";
                
                updateStatus(`‚ùå Error de comunicaci√≥n: ${errorMessage}`, 'error');
                
                // Restaurar el bot√≥n para que el usuario pueda reintentar
                registerButton.disabled = false;
                registerButton.textContent = 'Registrar Asistencia';
                registerButton.classList.remove('bg-gray-400');
                registerButton.classList.add('bg-green-600', 'hover:bg-green-700');

            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Iniciar la c√°mara
            startCamera();

            // 2. A√±adir listener al bot√≥n de registro
            registerButton.addEventListener('click', registerAttendance);
            
            // 3. Detener la c√°mara al cerrar la ventana
            window.addEventListener('beforeunload', stopCamera);
        });
        
    </script>
</body>
</html>